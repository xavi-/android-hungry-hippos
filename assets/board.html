<html>
	<head>
		<title>Box2dWeb Demo</title>
		<style>
			html, body { margin: 0; padding: 0; }
			button { display: block; width: 100%; height: 45px; border: none; }
			.board-container { position: relative; }
			#hippo-a, #hippo-b { display: none; position: absolute; }
			#hippo-a { -webkit-transform: rotate(180deg); -moz-transform: rotate(180deg); transform: rotate(180deg); }
		</style>
	</head>
	<body onload="init();">
		<button id="player-a">Bite it</button>
		<div class="board-container">
			<canvas id="canvas" style="background-color:#333333;" ></canvas>
			<img id="hippo-a" src="hippo.png"/>
			<img id="hippo-b" src="hippo.png"/>
		</div>
		<button id="player-b">Bite it2</button>
	</body>
	<script type="text/javascript" src="Box2dWeb-2.1.a.3.min.js"></script>
	<script type="text/javascript" src="jquery-2.0.0.js"></script>
	<script type="text/javascript">
		var DRAW_SCALE = 30;
		var WIDTH_PX = $(window).width(), HEIGHT_PX = $(window).height() - $("button").outerHeight() * 2;
		var WIDTH_UNIT = WIDTH_PX / DRAW_SCALE, HEIGHT_UNIT = HEIGHT_PX / DRAW_SCALE;

		var	b2Vec2 = Box2D.Common.Math.b2Vec2
		,	b2AABB = Box2D.Collision.b2AABB
		,	b2BodyDef = Box2D.Dynamics.b2BodyDef
		,	b2Body = Box2D.Dynamics.b2Body
		,	b2FixtureDef = Box2D.Dynamics.b2FixtureDef
		,	b2Fixture = Box2D.Dynamics.b2Fixture
		,	b2World = Box2D.Dynamics.b2World
		,	b2MassData = Box2D.Collision.Shapes.b2MassData
		,	b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape
		,	b2CircleShape = Box2D.Collision.Shapes.b2CircleShape
		,	b2DebugDraw = Box2D.Dynamics.b2DebugDraw
		,	b2MouseJointDef =  Box2D.Dynamics.Joints.b2MouseJointDef
		;

		function createMarbles(count) {
			var fixDef = new b2FixtureDef;
			fixDef.density = 1.0;
			fixDef.friction = 0.9;
			fixDef.restitution = 0.6;

			var bodyDef = new b2BodyDef;
			bodyDef.type = b2Body.b2_dynamicBody;
			for(var i = 0; i < count; ++i) {
				fixDef.shape = new b2CircleShape(0.5);
				bodyDef.position.x = WIDTH_UNIT * Math.random();
				bodyDef.position.y = HEIGHT_UNIT * Math.random();
				bodyDef.linearVelocity.x = 20 * Math.random() - 10;
				bodyDef.linearVelocity.y = 20 * Math.random() - 10;
				world.CreateBody(bodyDef).CreateFixture(fixDef);
			}

		}

		function init() {
			window.world = new b2World(
					new b2Vec2(0, 0) //gravity
				,	true //allow sleep
			);

			var fixDef = new b2FixtureDef;
			fixDef.density = 1.0;
			fixDef.friction = 0.1;
			fixDef.restitution = 0.6;

			var bodyDef = new b2BodyDef;

			//create ground
			bodyDef.type = b2Body.b2_staticBody;
			fixDef.shape = new b2PolygonShape;
			fixDef.shape.SetAsBox(WIDTH_UNIT, 2);
			bodyDef.position.Set(WIDTH_UNIT / 2, HEIGHT_UNIT + 1.8); // Center of box
			world.CreateBody(bodyDef).CreateFixture(fixDef);
			bodyDef.position.Set(WIDTH_UNIT / 2, -1.8); // Center of box
			world.CreateBody(bodyDef).CreateFixture(fixDef);
			fixDef.shape.SetAsBox(2, HEIGHT_UNIT / 2);
			bodyDef.position.Set(-1.8, HEIGHT_UNIT / 2);
			world.CreateBody(bodyDef).CreateFixture(fixDef);
			bodyDef.position.Set(WIDTH_UNIT + 1.8, HEIGHT_UNIT / 2);
			world.CreateBody(bodyDef).CreateFixture(fixDef);

			createMarbles(75);

			//setup debug draw
			var canvas = $("#canvas")[0];
			canvas.width = WIDTH_PX; canvas.height = HEIGHT_PX;
			var debugDraw = new b2DebugDraw();
			debugDraw.SetSprite(canvas.getContext("2d"));
			debugDraw.SetDrawScale(DRAW_SCALE);
			debugDraw.SetFillAlpha(0.5);
			debugDraw.SetLineThickness(1.0);
			debugDraw.SetFlags(b2DebugDraw.e_shapeBit | b2DebugDraw.e_jointBit);
			world.SetDebugDraw(debugDraw);

			window.setInterval(update, 1000 / 60);

			//update
			var centerVec = new b2Vec2(WIDTH_UNIT / 2, HEIGHT_UNIT / 2);
			function update() {

				world.Step(1 / 60, 10, 10);
				world.ClearForces();

				for(var marble = world.GetBodyList(); marble; marble = marble.GetNext()) {
					if(marble.GetType() !== b2Body.b2_dynamicBody) { continue; }

					var distVec = new b2Vec2(0, 0);
					distVec.Add(marble.GetWorldCenter());
					distVec.Subtract(centerVec);
					if(distVec.Length() < 4) { continue; }
					distVec.Normalize();
					distVec.Multiply(-1);
					marble.ApplyForce(distVec, marble.GetWorldCenter());
				}

				world.DrawDebugData();
			}
		};

		function bite(x, y) {
			var delBox = new b2AABB();
			delBox.lowerBound.Set(x - 1, y - 1);
			delBox.upperBound.Set(x + 1, y + 1);
			world.QueryAABB(function(fixture) {
				world.DestroyBody(fixture.GetBody());
				return true;
			}, delBox);

			var throwBox = new b2AABB();
			throwBox.lowerBound.Set(x - 2, y - 2);
			throwBox.upperBound.Set(x + 2, y + 2);
			world.QueryAABB(function(fixture) {
				var vec = new b2Vec2(30 * Math.random() - 15, 30 * Math.random() - 15);
				var body = fixture.GetBody();

				if(body.GetType() !== b2Body.b2_dynamicBody) { return true; }

				body.ApplyImpulse(vec, body.GetWorldCenter());
				return true;
			}, throwBox);

			for(var body = world.GetBodyList(); body; body = body.GetNext()) {
				if(body.GetType() !== b2Body.b2_dynamicBody) { continue; }

				var vec = new b2Vec2(6 * Math.random() - 3, 6 * Math.random() - 3);
				body.ApplyImpulse(vec, body.GetWorldCenter());
			}
		}

		function showHippo(hippoId, x, y) {
			$("#hippo-" + hippoId)
				.css({
					left: DRAW_SCALE * (x - 2),
					top: DRAW_SCALE * (y - 2),
					width: DRAW_SCALE * 4,
					height: DRAW_SCALE * 4
				})
				.show()
			;
		}
		function hideHippo(hippoId) {
			$("#hippo-" + hippoId).hide();
		}

		$("#hippo-a, #hippo-b").width(3 * DRAW_SCALE).height(3 * DRAW_SCALE);
		$("#player-a")
			.bind("touchstart mousedown", function() {
				showHippo("a", WIDTH_UNIT / 2, 4);
			})
			.bind("touchend mouseup", function() {
				bite(WIDTH_UNIT / 2, 4);
				hideHippo("a");
				createMarbles(1);
			})
		;
		$("#player-b")
			.bind("touchstart mousedown", function() {
				showHippo("b", WIDTH_UNIT / 2, HEIGHT_UNIT - 4);
			})
			.bind("touchend mouseup", function() {
				bite(WIDTH_UNIT / 2, HEIGHT_UNIT - 4);
				hideHippo("b");
				createMarbles(1);
			})
		;
	</script>
</html>